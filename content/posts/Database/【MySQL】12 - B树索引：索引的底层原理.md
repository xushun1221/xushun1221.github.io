---
title: 【MySQL】12 - B树索引：索引的底层原理
date: 2022-11-05
tags: [datebase, MySQL]
categories: [DateBase]
---


## MySQL索引的实现原理

MySQL支持两种索引，一种是**B-树索引**，一种是**哈希索引**，大家知道，B-树和哈希表在数据查询时的效率是非常高的。

这里我们主要讨论一下MySQL的InnoDB存储引擎，基于B-树（实际上采用的是B+树结构）的索引结构。B-树是一种m阶平衡树，叶子节点都在同一层，由于每一个节点存储的数据量比较大，索引整个B-树的层数是非常低的，基本上不超过三层。

由于磁盘的读取也是按block块操作的（内存是按page页面操作的），因此B-树的节点大小一般设置为和磁盘块大小一致，这样一个B-树节点，就可以通过一次磁盘I/O把一个磁盘块的数据全部存储下来，所以当使用B-树存储索引的时候，磁盘I/O的操作次数是最少的（MySQL的读写效率，主要集中在磁盘I/O上）。


> 热知识，数据库索引存放在磁盘上，使用索引时需要将索引读取到内存中，当数据量很大时，不能把整个索引全部加载到内存上，只能逐一加载每一个磁盘块（对应索引树的节点），索引树越低，越“矮胖”，磁盘IO次数就越少，效率越高。


索引的使用过程：sql查询`SELECT * FROM student WHERE uid=3;`=>uid有索引=>存储引擎=>kernel=>磁盘IO(读索引文件)=>内存(用索引数据构建B树加速搜索)



## B树

假设我们有2000W数据，使用AVL平衡二叉树存储索引结构，这棵树有`log2(20000000) == 25`层。也就是说，在最坏情况下，读取一个索引要花费25次磁盘IO。（一次磁盘IO读取数据放在一个节点上，最坏情况为索引节点都不在一个盘块上）

B树就是m叉平衡树，假设使用m=500叉B树存储索引结构，这棵树有`log500(20000000) == 3`层。也就是说，使用B树存储索引结构，读取一个索引，最多花费3次磁盘IO。

m如何取值？最好的情况就是，一次磁盘IO读取的盘块内容，刚好能存储在一个B树节点中。



-----

B树索引的结构：

![](/post_images/posts/Database/MySQL/B树索引结构.jpg "B树索引结构")

紫色内容就是，索引对应的字段的值。  
蓝色内容是，B树节点指向子节点信息的指针。

注意，橘黄色内容是什么？是表记录中除了索引对应字段之外的其他字段？还是指向磁盘中存储该条表记录的指针？

这取决于存储引擎的实现。之前分析过，MyISAM引擎，数据和索引存放在不同的文件中（`*.MYD  *.MYI`），而InnoDB引擎，数据和索引放在同一个文件中（`*.ibd`）。


对于B树索引的搜索，从根节点开始搜索，对于每层的数据，以`O(log(m))`的复杂度**二分查找**，再向下搜索。



## B+树









-----

B+树索引的结构：

![](/post_images/posts/Database/MySQL/B+树索引结构.jpg "B+树索引结构")














### 为什么用B+树？

终极问题：为什么MySQL使用B+树存储索引结构？B树和B+树在存储结构上有什么不同？

答：  
1. 