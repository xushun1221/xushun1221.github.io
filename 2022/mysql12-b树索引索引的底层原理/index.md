# 【MySQL】12 - B树索引：索引的底层原理



## MySQL索引的实现原理

MySQL支持两种索引，一种是**B-树索引**，一种是**哈希索引**，大家知道，B-树和哈希表在数据查询时的效率是非常高的。

这里我们主要讨论一下MySQL的InnoDB存储引擎，基于B-树（实际上采用的是B+树结构）的索引结构。B-树是一种m阶平衡树，叶子节点都在同一层，由于每一个节点存储的数据量比较大，索引整个B-树的层数是非常低的，基本上不超过三层。

由于磁盘的读取也是按block块操作的（内存是按page页面操作的），因此B-树的节点大小一般设置为和磁盘块大小一致，这样一个B-树节点，就可以通过一次磁盘I/O把一个磁盘块的数据全部存储下来，所以当使用B-树存储索引的时候，磁盘I/O的操作次数是最少的（MySQL的读写效率，主要集中在磁盘I/O上）。


> 热知识，数据库索引存放在磁盘上，使用索引时需要将索引读取到内存中，当数据量很大时，不能把整个索引全部加载到内存上，只能逐一加载每一个磁盘块（对应索引树的节点），索引树越低，越“矮胖”，磁盘IO次数就越少，效率越高。


索引的使用过程：sql查询`SELECT * FROM student WHERE uid=3;`=>uid有索引=>存储引擎=>kernel=>磁盘IO(读索引文件)=>内存(用索引数据构建B树加速搜索)



## B树

假设我们有2000W数据，使用AVL平衡二叉树存储索引结构，这棵树有`log2(20000000) == 25`层。也就是说，在最坏情况下，读取一个索引要花费25次磁盘IO。（一次磁盘IO读取数据放在一个节点上，最坏情况为索引节点都不在一个盘块上）

B树就是m叉平衡树，假设使用m=500叉B树存储索引结构，这棵树有`log500(20000000) == 3`层。也就是说，使用B树存储索引结构，读取一个索引，最多花费3次磁盘IO。

m如何取值？最好的情况就是，一次磁盘IO读取的盘块内容，刚好能存储在一个B树节点中。



-----

B树索引的结构：

![](/post_images/posts/Database/MySQL/B树索引结构.jpg "B树索引结构")

紫色内容就是，索引对应的字段的值。  
蓝色内容是，B树节点指向子节点信息的指针。

注意，橘黄色内容是什么？是表记录中除了索引对应字段之外的其他字段？还是指向磁盘中存储该条表记录的指针？

这取决于存储引擎的实现。之前分析过，MyISAM引擎，数据和索引存放在不同的文件中（`*.MYD  *.MYI`），而InnoDB引擎，数据和索引放在同一个文件中（`*.ibd`）。


对于B树索引的搜索，从根节点开始搜索，对于每层的数据，以`O(log(m))`的复杂度**二分查找**，再向下搜索。


## 为什么不用B树？

为什么MyISAM和InnoDB不使用B树而是使用B+树作为索引结构？B树存在哪些问题？

三个问题

1. 索引和数据内容分散在不同的节点上，离根节点近，搜索得快，离根节点远，搜索得慢。花费的磁盘IO次数不平均，每一行数据搜索花费的时间也不平均；
2. 每一个非叶子节点，不仅要存储索引（key），还要存储索引值所在的那一行的数据。如果节点只存储索引key而不存数据，那么节点能够存储的索引key的数量就要多得多；
3. B树不方便进行范围搜索，整表扫描也不方便。

上面的三个问题，使用B+树来解决！

## B+树


B+树索引的结构：

![](/post_images/posts/Database/MySQL/B+树索引结构.jpg "B+树索引结构")


从上图可以看出，B+索引树中，一个磁盘块大小的节点，仅存储索引key和子节点的指针，并不存储索引key对应的数据，这样一来，一个节点可以存储更多的索引key，这样B+树理论上层数更低，搜索效率更高！（更容易找到key）

所有的索引key和对应的数据都存放在叶子节点上，搜索每一个索引key对应的数据，都需要跑到叶子节点上，这样每一行记录搜索的时间都非常平均。（找到key对应的数据，效率更高、更平均）

所有的叶子节点被串在一个链表中，形成了一个有序的链表，如果要进行索引树搜搜、整表扫描、范围搜索，直接遍历叶子节点的有序链表即可。（方便范围搜索和整表扫描）




## 为什么用B+树？

终极问题：为什么MySQL使用B+树存储索引结构？B树和B+树在存储结构上有什么不同？

总结：  
1. B-树的每一个节点，存了关键字和对应的数据地址，而B+树的非叶子节点只存关键字，不存数据地址。因此B+树的每一个非叶子节点存储的关键字是远远多于B-树的，B+树的叶子节点存放关键字和数据，因此，从树的高度上来说，B+树的高度要小于B-树，使用的磁盘I/O次数少，因此查询会更快一些。
2. B-树由于每个节点都存储关键字和数据，因此离根节点进的数据，查询的就快，离根节点远的数据，查询的就慢；B+树所有的数据都存在叶子节点上，因此在B+树上搜索关键字，找到对应数据的时间是比较平均的，没有快慢之分。
3. 在B-树上如果做区间查找，遍历的节点是非常多的；B+树所有叶子节点被连接成了有序链表结构，因此做整表遍历和区间查找是非常容易的。


