# 【MySQL】19 - 事务并发问题&隔离级别


## 事务并发存在的问题

事务处理不经隔离，并发执行事务时通常会发生以下的问题：

- **脏读（Dirty Read）**：一个事务读取了另一个事务未提交的数据。例如当事务A和事务B并发执行时，当事务A更新后，事务B查询读取到A尚未提交的数据，此时事务A回滚，则事务B读到的数据就是无效的脏数据。（事务B读取了事务A尚**未提交**的数据）（绝对无法接受的）
- **不可重复读（NonRepeatable Read）**：一个事务的操作导致另一个事务前后两次读取到不同的数据。例如当事务A和事务B并发执行时，当事务B查询读取数据后，事务A更新操作更改事务B查询到的数据，此时事务B再次去读该数据，发现前后两次读的数据不一样。（事务B读取了事务A**已提交**的数据）（业务上不一定无法接受）
- **虚读（Phantom Read）幻读**：一个事务的操作导致另一个事务前后两次查询的结果数据量不同。例如当事务A和事务B并发执行时，当事务B查询读取数据后，事务A新增或者删除了一条满足事务B查询条件的记录，此时事务B再去查询，发现查询到前一次不存在的记录，或者前一次查询的一些记录不见了。（事务B读取了事务A新增加的数据或者读不到事务A删除的数据）（业务上不一定无法接受）

> 脏读是错误的，不可接受的；  
> 不可重复读和虚读，不是一种错误，是否允许要看业务的需求，取决于对事务并发程度高低的需要。

为了数据的安全性，提出了数据的隔离级别，在不同的程度上，允许或不允许脏读、不可重复读、虚读的出现。




## 事务的隔离级别

MySQL支持的四种隔离级别是：

1. `TRANSACTION_READ_UNCOMMITTED`，**未提交读**。说明在提交前一个事务可以看到另一个事务的变化。这样读脏数据，不可重复读和虚读都是被允许的；
2. `TRANSACTION_READ_COMMITTED`，**已提交读**。说明读取未提交的数据是不允许的。这个级别仍然允许不可重复读和虚读产生；
3. `TRANSACTION_REPEATABLE_READ`，**可重复读**。说明事务保证能够再次读取相同的数据而不会失败，但虚读仍然会出现；（MySQL的默认隔离级别）
4. `TRANSACTION_SERIALIZABLE`，**串行化**。不能并行，是最高的事务级别，它防止读脏数据，不可重复读和虚读。


|隔离级别|脏读|不可重复读|虚读|
|---|---|---|---|
|未提交读|Y|Y|Y|
|已提交读|N|Y|Y|
|可重复读|N|N|Y|
|串行化|N|N|N|


> 事务隔离级别越高，为避免冲突所花费的性能也就越多。  
> 在可重复读级别，实际上可以解决部分的虚读问题，但是不能防止update更新产生的虚读问题，要禁止虚读产生，还是需要设置串行化隔离级别。

MySQL的默认隔离级别是：可重复读。





## 示例

用两个终端各自连接mysql server进行测试，记住要关闭自动提交事务（`SET autocommit=0;`）。

用这个表：  
```sql
mysql> select * from user;
+----+----------+-----+-----+
| id | name     | age | sex |
+----+----------+-----+-----+
|  7 | zhangsan |  20 | m   |
|  8 | gaoyang  |  22 | w   |
|  9 | chenwei  |  20 | m   |
| 10 | zhangfan |  21 | w   |
| 11 | zhanglan |  22 | w   |
+----+----------+-----+-----+
5 rows in set (0.00 sec)
```

### 未提交读

<html>
    <table style="margin: auto">
        <tr>
            <td>
                <!--左侧内容-->
                <pre><code>
                    mysql> select * from user;
                    +----+----------+-----+-----+
                    | id | name     | age | sex |
                    +----+----------+-----+-----+
                    |  7 | zhangsan |  20 | m   |
                    |  8 | gaoyang  |  22 | w   |
                    |  9 | chenwei  |  20 | m   |
                    | 10 | zhangfan |  21 | w   |
                    | 11 | zhanglan |  22 | w   |
                    +----+----------+-----+-----+
                    5 rows in set (0.00 sec)
                </code></pre>
            </td>
            <td>
                <!--右侧内容-->
                <pre><code>
                    mysql> select * from user;
                    +----+----------+-----+-----+
                    | id | name     | age | sex |
                    +----+----------+-----+-----+
                    |  7 | zhangsan |  20 | m   |
                    |  8 | gaoyang  |  22 | w   |
                    |  9 | chenwei  |  20 | m   |
                    | 10 | zhangfan |  21 | w   |
                    | 11 | zhanglan |  22 | w   |
                    +----+----------+-----+-----+
                    5 rows in set (0.00 sec)
                </code></pre>
            </td>
        </tr>
    </table>
</html>


