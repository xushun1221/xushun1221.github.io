<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>【Linux系统编程】gcc编译器 静态库和动态库 | XuShun's Blog</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta name=Description content="XuShun的个人博客，记录学习和生活。"><link rel=prev href=https://xushun1221.github.io/2022/linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8Bgdb%E8%B0%83%E8%AF%95%E5%99%A8%E7%9A%84%E4%BD%BF%E7%94%A8/><link rel=canonical href=https://xushun1221.github.io/2022/linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8Bgcc%E7%BC%96%E8%AF%91%E5%99%A8-%E9%9D%99%E6%80%81%E5%BA%93%E5%92%8C%E5%8A%A8%E6%80%81%E5%BA%93/><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><meta name=twitter:card content="summary"><meta name=twitter:title content="【Linux系统编程】gcc编译器 静态库和动态库"><meta name=twitter:description content="gcc编译器可以参考gcc编译器 gdb调试器可以参考gdb调试器 gcc编译的四步骤 源文件（hello.c）编译为可执行文件（a.out）步骤"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"【Linux系统编程】gcc编译器 静态库和动态库","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/xushun1221.github.io\/2022\/linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8Bgcc%E7%BC%96%E8%AF%91%E5%99%A8-%E9%9D%99%E6%80%81%E5%BA%93%E5%92%8C%E5%8A%A8%E6%80%81%E5%BA%93\/"},"image":{"@type":"ImageObject","url":"https:\/\/xushun1221.github.io\/cover.png","width":800,"height":600},"genre":"posts","keywords":"Linux, gcc","wordcount":1763,"url":"https:\/\/xushun1221.github.io\/2022\/linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8Bgcc%E7%BC%96%E8%AF%91%E5%99%A8-%E9%9D%99%E6%80%81%E5%BA%93%E5%92%8C%E5%8A%A8%E6%80%81%E5%BA%93\/","datePublished":"2022-05-12T00:00:00\x2b00:00","dateModified":"2022-05-12T00:00:00\x2b00:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"xushun","logo":{"@type":"ImageObject","url":"https:\/\/xushun1221.github.io\/logo.png","width":127,"height":40}},"description":""}</script><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/css/lib/fontawesome-free/all.min.css></head><body><script>window.isDark=(window.localStorage&&window.localStorage.getItem('theme'))==='dark';window.isDark&&document.body.classList.add('dark-theme');</script><div class=wrapper><nav class=navbar><div class=top-scroll-bar></div><div class=navbar-container><div class="navbar-header animated bounceIn"><a href=https://xushun1221.github.io>XuShun's Blog</a></div><div class=navbar-menu><a class=menu-item href=https://xushun1221.github.io/posts>Posts</a><a class=menu-item href=https://xushun1221.github.io/tags>Tags</a><a class=menu-item href=https://xushun1221.github.io/categories>Categories</a><a class=menu-item href=https://xushun1221.github.io/about>About</a><a href=javascript:void(0); class=theme-switch><i class="fas fa-adjust fa-rotate-180 fa-fw" title="Switch Theme"></i></a></div></div></nav><nav class=navbar-mobile><div class=top-scroll-bar></div><div class=navbar-container><div class=navbar-header><div class="navbar-header-title animated bounceIn"><a href=https://xushun1221.github.io>XuShun's Blog</a></div><div class=menu-toggle id=menu-toggle><span></span><span></span><span></span></div></div><div class=navbar-menu id=mobile-menu><a class=menu-item href=https://xushun1221.github.io/posts>Posts</a><a class=menu-item href=https://xushun1221.github.io/tags>Tags</a><a class=menu-item href=https://xushun1221.github.io/categories>Categories</a><a class=menu-item href=https://xushun1221.github.io/about>About</a><a href=javascript:void(0); class=theme-switch><i class="fas fa-adjust fa-rotate-180 fa-fw" title="Switch Theme"></i></a></div></div></nav><main class=main><div class=container><article class=page><h1 class="post-title animated flipInX">【Linux系统编程】gcc编译器 静态库和动态库</h1><div class=post-meta><i class="far fa-calendar-alt fa-fw"></i>published on&nbsp;<time datetime=2022-05-12>2022-05-12</time>&nbsp;
<i class="fas fa-pencil-alt fa-fw"></i>about 1763 words&nbsp;<span class=post-category><i class="far fa-folder fa-fw"></i>included in&nbsp;<a href=https://xushun1221.github.io/categories/coding/>Coding</a>&nbsp;</span></div><div class=post-toc id=post-toc><h2 class=post-toc-title>Contents</h2><div class=post-toc-content><nav id=TableOfContents><ul><li><a href=#gcc编译的四步骤>gcc编译的四步骤</a></li><li><a href=#gcc编译的重要参数>gcc编译的重要参数</a></li><li><a href=#静态库和共享库动态库>静态库和共享库（动态库）</a></li><li><a href=#静态库的制作和使用>静态库的制作和使用</a></li><li><a href=#静态库使用及头文件对应>静态库使用及头文件对应</a></li><li><a href=#动态库制作和使用>动态库制作和使用</a></li></ul></nav></div></div><div class=post-toc-mobile id=post-toc-mobile><details><summary><div class=post-toc-title><span>Contents</span>
<span><i class="details icon fas fa-angle-down"></i></span></div></summary><div class=post-toc-content><nav id=TableOfContentsMobile><ul><li><a href=#gcc编译的四步骤>gcc编译的四步骤</a></li><li><a href=#gcc编译的重要参数>gcc编译的重要参数</a></li><li><a href=#静态库和共享库动态库>静态库和共享库（动态库）</a></li><li><a href=#静态库的制作和使用>静态库的制作和使用</a></li><li><a href=#静态库使用及头文件对应>静态库使用及头文件对应</a></li><li><a href=#动态库制作和使用>动态库制作和使用</a></li></ul></nav></div></details></div><div class=post-content><p>gcc编译器可以参考<a href=https://xushun1221.github.io/2022/linux%E4%B8%8B%E4%BD%BF%E7%94%A8vscode%E5%92%8Ccmake%E8%BF%9B%E8%A1%8Cc-%E5%BC%80%E5%8F%911/ target=_blank>gcc编译器</a><br>gdb调试器可以参考<a href=https://xushun1221.github.io/2022/linux%E4%B8%8B%E4%BD%BF%E7%94%A8vscode%E5%92%8Ccmake%E8%BF%9B%E8%A1%8Cc-%E5%BC%80%E5%8F%912/ target=_blank>gdb调试器</a></p><a class=post-dummy-target id=gcc编译的四步骤></a><h2>gcc编译的四步骤</h2><p>源文件（<code>hello.c</code>）编译为可执行文件（<code>a.out</code>）步骤：</p><ol><li>预处理(<code>gcc hello.c -E</code>)：展开宏和头文件，替换条件编译，删除注释和空白；</li><li>编译(<code>gcc hello.i -S</code>)：检查语法规范（消耗时间和系统资源最多）；</li><li>汇编(<code>gcc hello.s -c</code>)：汇编指令翻译为机器指令；</li><li>链接(<code>gcc hello.o 无参数</code>)：数据段合并，地址回填。</li></ol><a class=post-dummy-target id=gcc编译的重要参数></a><h2>gcc编译的重要参数</h2><p>主要掌握<code>-I -c -g -Wall -D</code>这几个。<br>这里做过笔记，就不在赘述了，<a href=https://xushun1221.github.io/2022/linux%E4%B8%8B%E4%BD%BF%E7%94%A8vscode%E5%92%8Ccmake%E8%BF%9B%E8%A1%8Cc-%E5%BC%80%E5%8F%911/#g%E9%87%8D%E8%A6%81%E7%9A%84%E7%BC%96%E8%AF%91%E5%8F%82%E6%95%B0 target=_blank>gcc编译重要参数</a>。</p><a class=post-dummy-target id=静态库和共享库动态库></a><h2>静态库和共享库（动态库）</h2><ul><li>静态库文件需要和应用程序一起编译到可执行文件中；</li><li>共享库无需和应用程序代码绑定，多个应用程序可以共享一个库文件，当程序某个函数调用动态库时，再从动态库中将代码加载即可；</li><li>静态库用在对空间要求较低，而对时间要求较高的核心程序中；</li><li>动态库用在对时间要求较低，而对空间要求较高的程序中。</li></ul><p>动态库的使用相对较多。</p><a class=post-dummy-target id=静态库的制作和使用></a><h2>静态库的制作和使用</h2><p>静态库名字通常以<code>lib</code>开头，以<code>.a</code>结尾，例如<code>libmymath.a</code>。<br>步骤：</p><ol><li>编写好源代码，假设这里编写好了三个文件<code>add.c sub.c div1.c</code>，三个文件中各自有一个算数函数（<code>int add(int a, int b) {...} ...</code>）；</li><li>将源代码编译为<code>.o</code>文件，使用命令<code>gcc -c add.c -o add.o</code>，其他两个一样；</li><li>使用<code>ar</code>工具制作静态库，<code>ar rs libmymath.a add.o sub.o div1.o</code>，将上面三个目标文件，放到名为<code>mymath</code>的静态库中（调用这个库时，将其称呼为<code>mymath</code>而不是<code>libmymath.a</code>）;</li><li>使用静态库，用一个测试程序<code>test.c</code>调用这三个算术函数，编译时将静态库和源代码一起编译，<code>gcc test.c libmymath.a -o test</code>（源码要写在前面）。</li></ol><p>可以结合这个一起看<a href=https://xushun1221.github.io/2022/linux%E4%B8%8B%E4%BD%BF%E7%94%A8vscode%E5%92%8Ccmake%E8%BF%9B%E8%A1%8Cc-%E5%BC%80%E5%8F%911/#%E7%94%9F%E6%88%90%E9%9D%99%E6%80%81%E5%BA%93%E6%96%87%E4%BB%B6-a target=_blank>静态库文件制作</a></p><a class=post-dummy-target id=静态库使用及头文件对应></a><h2>静态库使用及头文件对应</h2><p>如果编译上面的代码，编译器会报警告，隐式声明警告。<br>编译过程中，在函数调用之前，如果编译器没有见到过该函数的声明或定义，编译器就会帮你进行隐式的声明（编译器只会进行返回值为int的隐式声明，这里正好和我们的算术函数相同，所以进行了隐式声明，如果我们的函数长这样<code>void *add(int, int);</code>，就会报错误）。</p><p>在<code>test.c</code>源文件中，加入函数的声明即可解决这个问题。（不好的方式）</p><p>合理的方式应该是使用将<code>mymath</code>静态库中的函数声明写入头文件中<code>mymath.h</code>，在调用时包含该头文件即可<code>#include "mymath.h"</code>。<br>头文件写法要注意：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-c data-lang=c><span class=cp>#</span><span class=cp>ifndef _MYMATH_H_</span><span class=cp>
</span><span class=cp></span><span class=cp>#</span><span class=cp>define _MYMATH_H_</span><span class=cp>
</span><span class=cp></span>
<span class=kt>int</span> <span class=nf>add</span><span class=p>(</span><span class=kt>int</span><span class=p>,</span> <span class=kt>int</span><span class=p>)</span><span class=p>;</span>
<span class=kt>int</span> <span class=nf>sub</span><span class=p>(</span><span class=kt>int</span><span class=p>,</span> <span class=kt>int</span><span class=p>)</span><span class=p>;</span>
<span class=kt>int</span> <span class=nf>div1</span><span class=p>(</span><span class=kt>int</span><span class=p>,</span> <span class=kt>int</span><span class=p>)</span><span class=p>;</span>

<span class=cp>#</span><span class=cp>endif</span><span class=cp>
</span></code></pre></td></tr></table></div></div><p>这样的写法好处在于，无论包含该头文件多少次，该头文件只会被展开一次。第二次进入该头文件时就会判断<code>_MYMATH_H_</code>已经定义了，直接跳转到<code>#endif</code>。</p><a class=post-dummy-target id=动态库制作和使用></a><h2>动态库制作和使用</h2><p>制作动态库时，将<code>.c</code>文件编译为<code>.o</code>文件时，必须加上<code>-fPIC</code>选项，这和地址回填有关。<br>步骤：</p><ol><li>编写源代码；</li><li>将源代码编译为<code>.o</code>文件，<code>gcc -c add.c -fPIC -o add.o</code>；</li><li>使用<code>-shared</code>选项制作动态库，<code>gcc -shared libmymath.so add.o sub.o div1.o</code>，动态库一般以<code>lib</code>开头，<code>.so</code>结尾；</li><li>编译可执行程序时，指定所使用的动态库，<code>-l</code>指定库名，<code>-L</code>指定库路径，<code>gcc test.c -o test -lmymath -L./lib</code>，假设库在<code>./lib</code>目录下；</li><li><code>test</code>可执行文件成功生成，但是无法执行。</li></ol><p>执行出错的原因：</p><ul><li>链接器：工作于链接阶段，工作时需要<code>-l</code>和<code>-L</code>选项支持；</li><li>动态链接器：工作于程序运行阶段，工作时需要提供动态库所在目录位置。</li></ul><p>解决方法：</p><ol><li>通过环境变量<code>LD_LIBRARY_PATH</code>指定动态库位置，<code>export LD_LIBRARY_PATH=xxx</code>（要使用绝对路径），然后<code>./test</code>即可执行；(环境变量是进程的概念，切换终端后就会失效，如果希望永久生效，需要改动<code>~/.bashrc</code>配置文件，并运行<code>. .bashrc</code>，或者直接重启终端，每次启动终端时都会自动加载该配置文件)</li><li>这样好像也行，<code>LD_LIBRARY_PATH=xxx ./test</code>；</li><li>热知识，我们使用的标准c库也是动态库，使用时不需要设置该环境变量，因为它在<code>/lib</code>目录下的某个地方，我们可以把我们的动态库放到<code>/lib</code>目录下，运行时就无需设置环境变量，动态链接器会自动搜索<code>/lib</code>下的动态库；</li><li><code>sudo vi /etc/ld.so.conf</code>打开这个文件，写入动态库的绝对路径，保存，<code>sudo ldconfig -v</code>使配置文件生效。</li><li>（冷知识，<code>ldd test</code>命令可以查看程序运行时需要的动态库以及它们的位置）</li></ol></div><div class=post-copyright id=post-footer><p class=copyright-item><span>Author:&nbsp;</span>
<span>xushun</span></p><p class=copyright-item><span>Updated on:&nbsp;</span>
<span>2022-05-12</span></p><p class=copyright-item><span>Share on:&nbsp;</span>
<span><a href="//twitter.com/share?url=https%3a%2f%2fxushun1221.github.io%2f2022%2flinux%25E7%25B3%25BB%25E7%25BB%259F%25E7%25BC%2596%25E7%25A8%258Bgcc%25E7%25BC%2596%25E8%25AF%2591%25E5%2599%25A8-%25E9%259D%2599%25E6%2580%2581%25E5%25BA%2593%25E5%2592%258C%25E5%258A%25A8%25E6%2580%2581%25E5%25BA%2593%2f&text=%e3%80%90Linux%e7%b3%bb%e7%bb%9f%e7%bc%96%e7%a8%8b%e3%80%91gcc%e7%bc%96%e8%af%91%e5%99%a8%20%e9%9d%99%e6%80%81%e5%ba%93%e5%92%8c%e5%8a%a8%e6%80%81%e5%ba%93&via=" target=_blank title="Share on Twitter"><i class="fab fa-twitter fa-fw"></i></a><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fxushun1221.github.io%2f2022%2flinux%25E7%25B3%25BB%25E7%25BB%259F%25E7%25BC%2596%25E7%25A8%258Bgcc%25E7%25BC%2596%25E8%25AF%2591%25E5%2599%25A8-%25E9%259D%2599%25E6%2580%2581%25E5%25BA%2593%25E5%2592%258C%25E5%258A%25A8%25E6%2580%2581%25E5%25BA%2593%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook-square fa-fw"></i></a><a href="//reddit.com/submit?url=https%3a%2f%2fxushun1221.github.io%2f2022%2flinux%25E7%25B3%25BB%25E7%25BB%259F%25E7%25BC%2596%25E7%25A8%258Bgcc%25E7%25BC%2596%25E8%25AF%2591%25E5%2599%25A8-%25E9%259D%2599%25E6%2580%2581%25E5%25BA%2593%25E5%2592%258C%25E5%258A%25A8%25E6%2580%2581%25E5%25BA%2593%2f&title=%e3%80%90Linux%e7%b3%bb%e7%bb%9f%e7%bc%96%e7%a8%8b%e3%80%91gcc%e7%bc%96%e8%af%91%e5%99%a8%20%e9%9d%99%e6%80%81%e5%ba%93%e5%92%8c%e5%8a%a8%e6%80%81%e5%ba%93" target=_blank title="Share on Reddit"><i class="fab fa-reddit fa-fw"></i></a></span></p><p class=copyright-item></p><p class=copyright-item></p></div><br><div class=post-info-more><section><span class=tag><a href=https://xushun1221.github.io/tags/linux/><i class="fas fa-tag fa-fw"></i>&nbsp;Linux</a>&nbsp;
</span><span class=tag><a href=https://xushun1221.github.io/tags/gcc/><i class="fas fa-tag fa-fw"></i>&nbsp;gcc</a>&nbsp;</span></section><section><span><a href=javascript:window.history.back();>Back</a></span>&nbsp;|&nbsp;<span><a href=https://xushun1221.github.io>Home</a></span></section></div><div class=post-nav><a href=https://xushun1221.github.io/2022/linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8Bgdb%E8%B0%83%E8%AF%95%E5%99%A8%E7%9A%84%E4%BD%BF%E7%94%A8/ class=prev rel=prev title=【Linux系统编程】gdb调试器的使用><i class="fas fa-angle-left fa-fw"></i>【Linux系统编程】gdb调试器的使用</a></div><div class=post-comment></div></article></div></main><footer class=footer><div class=copyright><div class=copyright-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://xushun1221.github.io/about/ target=_blank>xushun</a> | </span>Powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreffer">Hugo</a> & <a href=https://github.com/dillonzq/LoveIt target=_blank rel="external nofollow noopener noreffer">LoveIt</a></div></div></footer></div><a href=# class=dynamic-to-top id=dynamic-to-top data-scroll><span>&nbsp;</span>
</a><script src=/js/lib/jquery/jquery.slim.min.js></script><script src=/js/lib/lazysizes/lazysizes.min.js></script><script src=/js/lib/smooth-scroll/smooth-scroll.polyfills.min.js></script><script>window.scroll=new SmoothScroll('[data-scroll]',{speed:300,speedAsDuration:true});</script><link rel=stylesheet href=/css/lib/katex/katex.min.css><script src=/js/lib/katex/katex.min.js></script><script defer src=/js/lib/katex/auto-render.min.js></script><link rel=stylesheet href=/css/lib/katex/copy-tex.min.css><script defer src=/js/lib/katex/copy-tex.min.js></script><script defer src=/js/lib/katex/mhchem.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:true},{left:"\\(",right:"\\)",display:false},{left:"\\[",right:"\\]",display:true},{left:"$",right:"$",display:false},]});});</script><script src=/js/blog.min.js></script></body></html>