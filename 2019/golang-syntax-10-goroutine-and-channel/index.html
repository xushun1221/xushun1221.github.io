<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Golang语法基础10-协程与通道 | XuShun's Blog</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta name=Description content="书藏的个人博客，包括Golang、数据结构、算法的学习记录，各类生活技能的学习，每周五发布一期自己的生活周刊"><link rel=prev href=https://xushun1221.github.io/2019/life-skills-9-maintenance-storage-and-disposal-of-used-clothes/><link rel=next href=https://xushun1221.github.io/2019/linux%E7%B3%BB%E7%BB%9F%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5/><link rel=canonical href=https://xushun1221.github.io/2019/golang-syntax-10-goroutine-and-channel/><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><meta name=twitter:card content="summary"><meta name=twitter:title content="Golang语法基础10-协程与通道"><meta name=twitter:description content="首先来回顾在操作系统中学过的一些概念。进程(processes)是程序执行的基本单位，运行在一个独立的内存地址空间中；一个进程由多个线程(t"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Golang语法基础10-协程与通道","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/xushun1221.github.io\/2019\/golang-syntax-10-goroutine-and-channel\/"},"image":{"@type":"ImageObject","url":"https:\/\/xushun1221.github.io\/cover.png","width":800,"height":600},"genre":"posts","keywords":"Go语法","wordcount":5826,"url":"https:\/\/xushun1221.github.io\/2019\/golang-syntax-10-goroutine-and-channel\/","datePublished":"2019-12-16T00:00:00\x2b00:00","dateModified":"2019-12-16T00:00:00\x2b00:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"shuzang","logo":{"@type":"ImageObject","url":"https:\/\/xushun1221.github.io\/logo.png","width":127,"height":40}},"description":""}</script><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/css/lib/fontawesome-free/all.min.css></head><body><script>window.isDark=(window.localStorage&&window.localStorage.getItem('theme'))==='dark';window.isDark&&document.body.classList.add('dark-theme');</script><div class=wrapper><nav class=navbar><div class=top-scroll-bar></div><div class=navbar-container><div class="navbar-header animated bounceIn"><a href=https://xushun1221.github.io>XuShun's Blog</a></div><div class=navbar-menu><a class=menu-item href=https://xushun1221.github.io/posts>Posts</a><a class=menu-item href=https://xushun1221.github.io/tags>Tags</a><a class=menu-item href=https://xushun1221.github.io/categories>Categories</a><a class=menu-item href=https://xushun1221.github.io/about>About</a><a href=javascript:void(0); class=theme-switch><i class="fas fa-adjust fa-rotate-180 fa-fw" title="Switch Theme"></i></a></div></div></nav><nav class=navbar-mobile><div class=top-scroll-bar></div><div class=navbar-container><div class=navbar-header><div class="navbar-header-title animated bounceIn"><a href=https://xushun1221.github.io>XuShun's Blog</a></div><div class=menu-toggle id=menu-toggle><span></span><span></span><span></span></div></div><div class=navbar-menu id=mobile-menu><a class=menu-item href=https://xushun1221.github.io/posts>Posts</a><a class=menu-item href=https://xushun1221.github.io/tags>Tags</a><a class=menu-item href=https://xushun1221.github.io/categories>Categories</a><a class=menu-item href=https://xushun1221.github.io/about>About</a><a href=javascript:void(0); class=theme-switch><i class="fas fa-adjust fa-rotate-180 fa-fw" title="Switch Theme"></i></a></div></div></nav><main class=main><div class=container><article class=page><h1 class="post-title animated flipInX">Golang语法基础10-协程与通道</h1><div class=post-meta><i class="far fa-calendar-alt fa-fw"></i>published on&nbsp;<time datetime=2019-12-16>2019-12-16</time>&nbsp;
<i class="fas fa-pencil-alt fa-fw"></i>about 5826 words&nbsp;<span class=post-category><i class="far fa-folder fa-fw"></i>included in&nbsp;<a href=https://xushun1221.github.io/categories/golang%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF/>Golang学习之路</a>&nbsp;</span></div><div class=post-toc id=post-toc><h2 class=post-toc-title>Contents</h2><div class=post-toc-content><nav id=TableOfContents><ul><li><a href=#1-goroutines>1. Goroutines</a></li><li><a href=#2-channel>2. Channel</a><ul><li><a href=#21-声明与初始化>2.1 声明与初始化</a></li><li><a href=#22-通信操作符->2.2 通信操作符<-</a></li><li><a href=#23-通道阻塞>2.3 通道阻塞</a></li><li><a href=#24-信号量模式>2.4 信号量模式</a></li><li><a href=#25-通道工厂>2.5 通道工厂</a></li><li><a href=#26-给通道使用for循环>2.6 给通道使用for循环</a></li><li><a href=#27-关闭通道>2.7 关闭通道</a></li></ul></li><li><a href=#3-select>3. Select</a></li><li><a href=#4-应用>4. 应用</a><ul><li><a href=#41-惰性生成器>4.1 惰性生成器</a></li><li><a href=#42-futures-模式>4.2 Futures 模式</a></li><li><a href=#43-cs模式>4.3 C/S模式</a></li></ul></li></ul></nav></div></div><div class=post-toc-mobile id=post-toc-mobile><details><summary><div class=post-toc-title><span>Contents</span>
<span><i class="details icon fas fa-angle-down"></i></span></div></summary><div class=post-toc-content><nav id=TableOfContentsMobile><ul><li><a href=#1-goroutines>1. Goroutines</a></li><li><a href=#2-channel>2. Channel</a><ul><li><a href=#21-声明与初始化>2.1 声明与初始化</a></li><li><a href=#22-通信操作符->2.2 通信操作符<-</a></li><li><a href=#23-通道阻塞>2.3 通道阻塞</a></li><li><a href=#24-信号量模式>2.4 信号量模式</a></li><li><a href=#25-通道工厂>2.5 通道工厂</a></li><li><a href=#26-给通道使用for循环>2.6 给通道使用for循环</a></li><li><a href=#27-关闭通道>2.7 关闭通道</a></li></ul></li><li><a href=#3-select>3. Select</a></li><li><a href=#4-应用>4. 应用</a><ul><li><a href=#41-惰性生成器>4.1 惰性生成器</a></li><li><a href=#42-futures-模式>4.2 Futures 模式</a></li><li><a href=#43-cs模式>4.3 C/S模式</a></li></ul></li></ul></nav></div></details></div><div class=post-content><p>首先来回顾在操作系统中学过的一些概念。进程(processes)是程序执行的基本单位，运行在一个独立的内存地址空间中；一个进程由多个线程(threads)组成，线程的存在是为了能够同时执行多个任务，最大化利用时间，防止产生等待，线程间是共享内存地址空间的。从windows资源管理器看这一点能看的很明白，如下，每个应用程序是一个进程，Typora程序下有两个线程在同时运行。</p><p><figure><img src=/svg/loading.min.svg data-sizes=auto data-src=https://picped-1301226557.cos.ap-beijing.myqcloud.com/Go_20191216_3EkjsJ.png alt=进程与线程 class=lazyload><figcaption class=image-caption>进程与线程</figcaption></figure></p><p>并发是建立在多线程之上的概念，将CPU的执行时间划分为许多很小的间隔，多个线程不断地切换执行，从上层看起来就像在同时执行一样，但本质上依然是线性的。并行则是程序在某个特定的事件同时运行在多个CPU上，多核处理器为并行提供了可能。因此，并发也可能是并行的。</p><p>操作系统课程中一个最主要的问题就是多线程对共享内存空间的访问，我们学到的解决方式是通过加互斥锁来实现，但在设计实现上是一个复杂的过程，非常容易出错，鉴于操作系统考试的惨痛经历，现在完全不想回忆。Go中的标准库<code>sync</code>中有一些工具可以用来实现互斥锁的相关操作，但它显然没有Go自身支持的Goroutines高效。</p><a class=post-dummy-target id=1-goroutines></a><h2>1. Goroutines</h2><p>Go原生支持并发，依靠的是协程(goroutine)和通道(channel)两个概念。goroutines的概念是为了和processes、threads、coroutines等概念区别。其中coroutines也叫做协程，而且这才是常规意义下的协程，goroutines只在Go中有效。</p><p>coroutines是比线程更轻的一个概念，只使用很少的内存和资源。它对栈进行分隔，从而动态地增加或缩减内存的使用，栈的管理也是自动的，在协程退出后自动释放空间。协程可以运行在多个线程间，也可以运行在线程内，它的创建廉价到可以在同一地址空间存在100000个。这一概念也存在于其它语言(C#, Java等)中，它与goroutines的区别在于：</p><ul><li>Go协程意味着并行(或者可以以并行的方式部署)，协程一般不是</li><li>Go协程通过通道来通信，协程则通过让出与恢复操作来通信</li></ul><p>理论上，Go协程比协程更加强大。</p><p>以一个简单模型来描述goroutine：它是一个和其它协程在同一地址空间并发执行的函数。通过在函数或方法名前加上<code>go</code>关键字来创建和运行一个协程，运行结束后安静的退出(没有任何返回值)。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=k>go</span> <span class=nx>list</span><span class=p>.</span><span class=nf>Sort</span><span class=p>(</span><span class=p>)</span> <span class=c1>//并行的运行list.Sort，不等待
</span></code></pre></td></tr></table></div></div><p>Go程序中必须含有的<code>main()</code>函数可以看作一个协程，尽管它没有通过<code>go</code>关键字启动，在程序初始化的过程中(<code>init()</code>函数运行)，goroutine也可以运行。</p><p>单纯的结束协程的概念是不够具体的，协程需要和通道来配合</p><a class=post-dummy-target id=2-channel></a><h2>2. Channel</h2><p>并发编程的困难之处在于实现对共享变量的正确访问，互斥量的方式是复杂的，Go鼓励采用一种不同的方法，即在通道(channel)上传递共享值，如同Unix管道一般，通道用于发送类型化的数据，在任何给定的时间，只有一个协程可以对通道中的数据进行访问，从而完成协程间的通信，也避开了所有由共享内存导致的陷阱。这种通过通道进行通信的方式保证同步性的同时，数据的所有权也因此被传递。</p><p>这一设计理念最终简化为一句话：<strong>不要通过共享内存来通信，而通过通信来共享内存</strong>。</p><a class=post-dummy-target id=21-声明与初始化></a><h3>2.1 声明与初始化</h3><p>声明通道的基本形式如下，未初始化的通道值为nil</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=kd>var</span> <span class=nx>identifier</span> <span class=kd>chan</span> <span class=nx>datatype</span>
</code></pre></td></tr></table></div></div><p>通道只能传输一种类型的数据，比如<code>chan int</code>或<code>chan string</code>，可以是任意类型，包括空接口<code>interface{}</code>和通道自己</p><p>和map相同，通道也是引用类型，因此使用<code>make</code>进行初始化，可以指定第二个参数用来指定缓冲区的大小，即通道可容纳的数据个数，这一个值默认是0，意思是无缓冲，无缓冲的通道将通信、值的交换、同步三者结合，保证两个协程的计算处于已知状态。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=kd>var</span> <span class=nx>ci</span> <span class=kd>chan</span> <span class=kt>string</span>
<span class=nx>ci</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>string</span><span class=p>)</span>			<span class=c1>// unbuffered channel of integers
</span><span class=c1></span>
<span class=nx>cj</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>int</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>         <span class=c1>// unbuffered channel of integers
</span><span class=c1></span><span class=nx>cs</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=o>*</span><span class=nx>os</span><span class=p>.</span><span class=nx>File</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span>  <span class=c1>// buffered channel of pointers to Files
</span></code></pre></td></tr></table></div></div><a class=post-dummy-target id=22-通信操作符-></a><h3>2.2 通信操作符&lt;-</h3><p>这一操作符直观的表示数据的传输：信息按照箭头方向流动。</p><p>流向通道(发送)用<code>ch &lt;- int1</code>表示，意为利用通道ch发送变量int1</p><p>从通道流出(接收)用<code>int2 = &lt;- ch</code>表示，意为变量int2从通道ch接收数据，如果int2没有声明过，可以使用<code>int2 := &lt;- ch</code></p><p><code>&lt;- ch</code>则用于表示丢弃当前值，获取通道的下一个值，可以用来验证，如</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=k>if</span> <span class=o>&lt;-</span> <span class=nx>ch</span> <span class=o>!=</span> <span class=mi>1000</span> <span class=p>{</span>
    <span class=o>...</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>为了可读性通道的命名通常以 <code>ch</code> 开头或者包含 <code>chan</code>。通道的发送和接收都是原子操作，总是互不干扰的完成。下面的示例展示了通信操作符的使用。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>main</span>

<span class=kn>import</span> <span class=p>(</span>
	<span class=s>&#34;fmt&#34;</span>
	<span class=s>&#34;time&#34;</span>
<span class=p>)</span>

<span class=kd>func</span> <span class=nf>main</span><span class=p>(</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>ch</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>string</span><span class=p>)</span>

	<span class=k>go</span> <span class=nf>sendData</span><span class=p>(</span><span class=nx>ch</span><span class=p>)</span>
	<span class=k>go</span> <span class=nf>getData</span><span class=p>(</span><span class=nx>ch</span><span class=p>)</span>

	<span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mf>1e9</span><span class=p>)</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>sendData</span><span class=p>(</span><span class=nx>ch</span> <span class=kd>chan</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>ch</span> <span class=o>&lt;-</span> <span class=s>&#34;Washington&#34;</span>
	<span class=nx>ch</span> <span class=o>&lt;-</span> <span class=s>&#34;Tripoli&#34;</span>
	<span class=nx>ch</span> <span class=o>&lt;-</span> <span class=s>&#34;London&#34;</span>
	<span class=nx>ch</span> <span class=o>&lt;-</span> <span class=s>&#34;Beijing&#34;</span>
	<span class=nx>ch</span> <span class=o>&lt;-</span> <span class=s>&#34;Tokyo&#34;</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>getData</span><span class=p>(</span><span class=nx>ch</span> <span class=kd>chan</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
	<span class=kd>var</span> <span class=nx>input</span> <span class=kt>string</span>
	<span class=c1>// time.Sleep(2e9)
</span><span class=c1></span>	<span class=k>for</span> <span class=p>{</span>
		<span class=nx>input</span> <span class=p>=</span> <span class=o>&lt;-</span><span class=nx>ch</span>
		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;%s &#34;</span><span class=p>,</span> <span class=nx>input</span><span class=p>)</span>
	<span class=p>}</span>
<span class=p>}</span>
<span class=c1>//Output:
</span><span class=c1></span><span class=nx>Washington</span> <span class=nx>Tripoli</span> <span class=nx>London</span> <span class=nx>Beijing</span> <span class=nx>tokyo</span>
</code></pre></td></tr></table></div></div><p>如果2个协程需要通信，必须给它们同一个通道作为参数。上例中 <code>main()</code> 函数中启动了两个协程：<code>sendData()</code> 通过通道 ch 发送了 5 个字符串，<code>getData()</code> 按顺序接收它们并打印出来。 一些同步的细节如下：</p><ul><li>main() 等待了 1 秒让两个协程完成，如果不这样(注释掉<code>time.Sleep(1e9)</code>)，sendData() 就没有机会输出。</li><li>getData() 使用了无限循环：它随着 sendData() 的发送完成和 ch 变空也结束了。</li><li>如果我们移除一个或所有 <code>go</code> 关键字，程序无法运行，Go 运行时会抛出 panic。这是因为运行时(runtime)会检查所有的协程是否在等待什么东西(从通道读取或写入某个通道)，这意味着陷入死锁，程序无法继续执行。</li></ul><p>通道的发送和接收顺序是无法预知的，如果使用打印状态来输出，由于两者间的时间延迟，打印的顺序和真实发生的顺序是不同的。</p><a class=post-dummy-target id=23-通道阻塞></a><h3>2.3 通道阻塞</h3><p>前面提到默认情况下通信是同步且无缓冲的，因此通道的发送/接收操作在对方准备好之前是阻塞的。</p><ol><li>对于同一个通道，发送操作（协程或者函数中的），在接收者准备好之前是阻塞的：如果ch中的数据无人接收，就无法再给通道传入其他数据</li><li>对于同一个通道，接收操作在发送者可用之前是阻塞的（协程或函数中的）</li></ol><p>下例中的协程在无限循环中不断地给通道发送数据，但由于没有接收者，只输出了数字0</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>main</span>

<span class=kn>import</span> <span class=s>&#34;fmt&#34;</span>

<span class=kd>func</span> <span class=nf>main</span><span class=p>(</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>ch1</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>int</span><span class=p>)</span>
	<span class=k>go</span> <span class=nf>pump</span><span class=p>(</span><span class=nx>ch1</span><span class=p>)</span>       <span class=c1>// pump hangs
</span><span class=c1></span>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=o>&lt;-</span><span class=nx>ch1</span><span class=p>)</span> <span class=c1>// prints only 0
</span><span class=c1></span><span class=p>}</span>

<span class=kd>func</span> <span class=nf>pump</span><span class=p>(</span><span class=nx>ch</span> <span class=kd>chan</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
		<span class=nx>ch</span> <span class=o>&lt;-</span> <span class=nx>i</span>
	<span class=p>}</span>
<span class=p>}</span>
<span class=c1>//Output:0
</span></code></pre></td></tr></table></div></div><p>定义一个新的协程用来接收通道值可以持续输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>main</span>

<span class=kn>import</span> <span class=s>&#34;fmt&#34;</span>

<span class=kd>func</span> <span class=nf>main</span><span class=p>(</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>ch1</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>int</span><span class=p>)</span>
	<span class=k>go</span> <span class=nf>pump</span><span class=p>(</span><span class=nx>ch1</span><span class=p>)</span>
	<span class=k>go</span> <span class=nf>suck</span><span class=p>(</span><span class=nx>ch1</span><span class=p>)</span>
	<span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mf>1e9</span><span class=p>)</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>pump</span><span class=p>(</span><span class=nx>ch</span> <span class=kd>chan</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
		<span class=nx>ch</span> <span class=o>&lt;-</span> <span class=nx>i</span>
	<span class=p>}</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>suck</span><span class=p>(</span><span class=nx>ch</span> <span class=kd>chan</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
	<span class=k>for</span> <span class=p>{</span>
		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=o>&lt;-</span><span class=nx>ch</span><span class=p>)</span>
	<span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><a class=post-dummy-target id=24-信号量模式></a><h3>2.4 信号量模式</h3><p>信号量模式的意思是利用通道阻塞特性，等待所有计算完成后才让程序退出，用于并行执行函数或for循环，加快程序执行速度，一个例子瑞小安</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=kd>type</span> <span class=nx>Empty</span> <span class=kd>interface</span> <span class=p>{</span><span class=p>}</span>
<span class=kd>var</span> <span class=nx>empty</span> <span class=nx>Empty</span>
<span class=o>...</span>
<span class=nx>data</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=p>[</span><span class=p>]</span><span class=kt>float64</span><span class=p>,</span> <span class=nx>N</span><span class=p>)</span>
<span class=nx>res</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=p>[</span><span class=p>]</span><span class=kt>float64</span><span class=p>,</span> <span class=nx>N</span><span class=p>)</span>
<span class=nx>sem</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>Empty</span><span class=p>,</span> <span class=nx>N</span><span class=p>)</span>
<span class=o>...</span>
<span class=k>for</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>xi</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>data</span> <span class=p>{</span>
	<span class=k>go</span> <span class=kd>func</span> <span class=p>(</span><span class=nx>i</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>xi</span> <span class=kt>float64</span><span class=p>)</span> <span class=p>{</span>
		<span class=nx>res</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>=</span> <span class=nf>doSomething</span><span class=p>(</span><span class=nx>i</span><span class=p>,</span> <span class=nx>xi</span><span class=p>)</span>
		<span class=nx>sem</span> <span class=o>&lt;-</span> <span class=nx>empty</span>
	<span class=p>}</span> <span class=p>(</span><span class=nx>i</span><span class=p>,</span> <span class=nx>xi</span><span class=p>)</span>
<span class=p>}</span>
<span class=c1>// wait for goroutines to finish
</span><span class=c1></span><span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>N</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span> <span class=o>&lt;-</span><span class=nx>sem</span> <span class=p>}</span>
</code></pre></td></tr></table></div></div><a class=post-dummy-target id=25-通道工厂></a><h3>2.5 通道工厂</h3><p>编程时常用一种通道工厂的模式，即不将通道作为参数传递给协程，而是用函数来生成一个通道并返回</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>main</span>

<span class=kn>import</span> <span class=p>(</span>
	<span class=s>&#34;fmt&#34;</span>
	<span class=s>&#34;time&#34;</span>
<span class=p>)</span>

<span class=kd>func</span> <span class=nf>main</span><span class=p>(</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>stream</span> <span class=o>:=</span> <span class=nf>pump</span><span class=p>(</span><span class=p>)</span>
	<span class=k>go</span> <span class=nf>suck</span><span class=p>(</span><span class=nx>stream</span><span class=p>)</span>
	<span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mf>1e9</span><span class=p>)</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>pump</span><span class=p>(</span><span class=p>)</span> <span class=kd>chan</span> <span class=kt>int</span> <span class=p>{</span>
	<span class=nx>ch</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>int</span><span class=p>)</span>
	<span class=k>go</span> <span class=kd>func</span><span class=p>(</span><span class=p>)</span> <span class=p>{</span>
		<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
			<span class=nx>ch</span> <span class=o>&lt;-</span> <span class=nx>i</span>
		<span class=p>}</span>
	<span class=p>}</span><span class=p>(</span><span class=p>)</span>
	<span class=k>return</span> <span class=nx>ch</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>suck</span><span class=p>(</span><span class=nx>ch</span> <span class=kd>chan</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
	<span class=k>for</span> <span class=p>{</span>
		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=o>&lt;-</span><span class=nx>ch</span><span class=p>)</span>
	<span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><a class=post-dummy-target id=26-给通道使用for循环></a><h3>2.6 给通道使用for循环</h3><p><code>for</code> 循环的 <code>range</code> 语句可以用在通道 <code>ch</code> 上，便可以从通道中获取值，像这样：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=k>for</span> <span class=nx>v</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>ch</span> <span class=p>{</span>
	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;The value is %v\n&#34;</span><span class=p>,</span> <span class=nx>v</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>这样的使用依然必须和通道的写入和关闭相配合， 不能单独存在</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>main</span>

<span class=kn>import</span> <span class=p>(</span>
	<span class=s>&#34;fmt&#34;</span>
	<span class=s>&#34;time&#34;</span>
<span class=p>)</span>

<span class=kd>func</span> <span class=nf>main</span><span class=p>(</span><span class=p>)</span> <span class=p>{</span>
	<span class=nf>suck</span><span class=p>(</span><span class=nf>pump</span><span class=p>(</span><span class=p>)</span><span class=p>)</span>
	<span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mf>1e9</span><span class=p>)</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>pump</span><span class=p>(</span><span class=p>)</span> <span class=kd>chan</span> <span class=kt>int</span> <span class=p>{</span>
	<span class=nx>ch</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>int</span><span class=p>)</span>
	<span class=k>go</span> <span class=kd>func</span><span class=p>(</span><span class=p>)</span> <span class=p>{</span>
		<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
			<span class=nx>ch</span> <span class=o>&lt;-</span> <span class=nx>i</span>
		<span class=p>}</span>
	<span class=p>}</span><span class=p>(</span><span class=p>)</span>
	<span class=k>return</span> <span class=nx>ch</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>suck</span><span class=p>(</span><span class=nx>ch</span> <span class=kd>chan</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
	<span class=k>go</span> <span class=kd>func</span><span class=p>(</span><span class=p>)</span> <span class=p>{</span>
		<span class=k>for</span> <span class=nx>v</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>ch</span> <span class=p>{</span>
			<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>v</span><span class=p>)</span>
		<span class=p>}</span>
	<span class=p>}</span><span class=p>(</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><a class=post-dummy-target id=27-关闭通道></a><h3>2.7 关闭通道</h3><p>通道可以被显式的关闭，不过只有发送者才需要关闭通道，接收者永远不需要。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=nx>ch</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>float64</span><span class=p>)</span>
<span class=k>defer</span> <span class=nb>close</span><span class=p>(</span><span class=nx>ch</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>测试通道是否关闭则可以使用ok操作符</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=nx>v</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>ch</span>   <span class=c1>// ok is true if v received value
</span></code></pre></td></tr></table></div></div><p>一个完整的例子如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>main</span>

<span class=kn>import</span> <span class=s>&#34;fmt&#34;</span>

<span class=kd>func</span> <span class=nf>main</span><span class=p>(</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>ch</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>string</span><span class=p>)</span>
	<span class=k>go</span> <span class=nf>sendData</span><span class=p>(</span><span class=nx>ch</span><span class=p>)</span>
	<span class=nf>getData</span><span class=p>(</span><span class=nx>ch</span><span class=p>)</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>sendData</span><span class=p>(</span><span class=nx>ch</span> <span class=kd>chan</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>ch</span> <span class=o>&lt;-</span> <span class=s>&#34;Washington&#34;</span>
	<span class=nx>ch</span> <span class=o>&lt;-</span> <span class=s>&#34;Tripoli&#34;</span>
	<span class=nx>ch</span> <span class=o>&lt;-</span> <span class=s>&#34;London&#34;</span>
	<span class=nx>ch</span> <span class=o>&lt;-</span> <span class=s>&#34;Beijing&#34;</span>
	<span class=nx>ch</span> <span class=o>&lt;-</span> <span class=s>&#34;Tokio&#34;</span>
	<span class=nb>close</span><span class=p>(</span><span class=nx>ch</span><span class=p>)</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>getData</span><span class=p>(</span><span class=nx>ch</span> <span class=kd>chan</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
	<span class=k>for</span> <span class=p>{</span>
		<span class=nx>input</span><span class=p>,</span> <span class=nx>open</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>ch</span>
		<span class=k>if</span> <span class=p>!</span><span class=nx>open</span> <span class=p>{</span>
			<span class=k>break</span>
		<span class=p>}</span>
		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;%s &#34;</span><span class=p>,</span> <span class=nx>input</span><span class=p>)</span>
	<span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>但是使用for-range读取通道是更好的办法，因为这会自动检测通道是否关闭</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=k>for</span> <span class=nx>input</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>ch</span> <span class=p>{</span>
  	<span class=nf>process</span><span class=p>(</span><span class=nx>input</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><a class=post-dummy-target id=3-select></a><h2>3. Select</h2><p>从不同的并发执行的协程中获取值可以通过关键字<code>select</code>来完成，它和<code>switch</code>控制语句非常相似，其行为像是“你准备好了吗”的轮询机制；<code>select</code>监听进入通道的数据，也可以是用通道发送值的时候。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=k>select</span> <span class=p>{</span>
<span class=k>case</span> <span class=nx>u</span><span class=o>:=</span> <span class=o>&lt;-</span> <span class=nx>ch1</span><span class=p>:</span>
        <span class=o>...</span>
<span class=k>case</span> <span class=nx>v</span><span class=o>:=</span> <span class=o>&lt;-</span> <span class=nx>ch2</span><span class=p>:</span>
        <span class=o>...</span>
        <span class=o>...</span>
<span class=k>default</span><span class=p>:</span> <span class=c1>// no value ready to be received
</span><span class=c1></span>        <span class=o>...</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><code>select</code> 做的事情是：选择处理列出的多个通信情况中的一个。</p><ul><li>如果都阻塞了，会等待直到其中一个可以处理</li><li>如果多个可以处理，随机选择一个</li><li>如果没有通道操作可以处理并且写了 <code>default</code> 语句，它就会执行：<code>default</code> 永远是可运行的（这就是准备好了，可以执行）。</li></ul><p>使用<code>default</code>可以保证发送不被阻塞，但没有<code>default</code>的监听模式也可能被使用，通过<code>break</code>语句退出循环。一个完整的例子如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>main</span>

<span class=kn>import</span> <span class=p>(</span>
	<span class=s>&#34;fmt&#34;</span>
	<span class=s>&#34;time&#34;</span>
<span class=p>)</span>

<span class=kd>func</span> <span class=nf>main</span><span class=p>(</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>ch1</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>int</span><span class=p>)</span>
	<span class=nx>ch2</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>int</span><span class=p>)</span>

	<span class=k>go</span> <span class=nf>pump1</span><span class=p>(</span><span class=nx>ch1</span><span class=p>)</span>
	<span class=k>go</span> <span class=nf>pump2</span><span class=p>(</span><span class=nx>ch2</span><span class=p>)</span>
	<span class=k>go</span> <span class=nf>suck</span><span class=p>(</span><span class=nx>ch1</span><span class=p>,</span> <span class=nx>ch2</span><span class=p>)</span>

	<span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mf>1e9</span><span class=p>)</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>pump1</span><span class=p>(</span><span class=nx>ch</span> <span class=kd>chan</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
		<span class=nx>ch</span> <span class=o>&lt;-</span> <span class=nx>i</span> <span class=o>*</span> <span class=mi>2</span>
	<span class=p>}</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>pump2</span><span class=p>(</span><span class=nx>ch</span> <span class=kd>chan</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
		<span class=nx>ch</span> <span class=o>&lt;-</span> <span class=nx>i</span> <span class=o>+</span> <span class=mi>5</span>
	<span class=p>}</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>suck</span><span class=p>(</span><span class=nx>ch1</span><span class=p>,</span> <span class=nx>ch2</span> <span class=kd>chan</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
	<span class=k>for</span> <span class=p>{</span>
		<span class=k>select</span> <span class=p>{</span>
		<span class=k>case</span> <span class=nx>v</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>ch1</span><span class=p>:</span>
			<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Received on channel 1: %d\n&#34;</span><span class=p>,</span> <span class=nx>v</span><span class=p>)</span>
		<span class=k>case</span> <span class=nx>v</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>ch2</span><span class=p>:</span>
			<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Received on channel 2: %d\n&#34;</span><span class=p>,</span> <span class=nx>v</span><span class=p>)</span>
		<span class=p>}</span>
	<span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>有 2 个通道 <code>ch1</code> 和 <code>ch2</code>，三个协程 <code>pump1()</code>、<code>pump2()</code> 和 <code>suck()</code>。在无限循环中，<code>ch1</code> 和 <code>ch2</code> 通过 <code>pump1()</code> 和 <code>pump2()</code> 填充整数；<code>suck()</code> 也在无限循环中轮询输入，通过 <code>select</code> 语句获取 <code>ch1</code> 和 <code>ch2</code> 的整数并输出。选择哪一个 case 取决于哪一个通道收到了信息。程序在 main 执行 1 秒后结束。</p><a class=post-dummy-target id=4-应用></a><h2>4. 应用</h2><a class=post-dummy-target id=41-惰性生成器></a><h3>4.1 惰性生成器</h3><p>生成器是指当被调用时返回一个序列中下一个值的函数，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=nf>generateInteger</span><span class=p>(</span><span class=p>)</span> <span class=p>=</span><span class=p>&gt;</span> <span class=mi>0</span>
<span class=nf>generateInteger</span><span class=p>(</span><span class=p>)</span> <span class=p>=</span><span class=p>&gt;</span> <span class=mi>1</span>
<span class=nf>generateInteger</span><span class=p>(</span><span class=p>)</span> <span class=p>=</span><span class=p>&gt;</span> <span class=mi>2</span>
<span class=o>...</span><span class=p>.</span>
</code></pre></td></tr></table></div></div><p>生成器每次返回的是序列中下一个值而非整个序列；这种特性也称之为惰性求值：只在你需要时进行求值，同时保留相关变量资源（内存和cpu）：这是一项在需要时对表达式进行求值的技术。例如，生成一个无限数量的偶数序列：要产生这样一个序列并且在一个一个的使用可能会很困难，而且内存会溢出！但是一个含有通道和go协程的函数能轻易实现这个需求。</p><p>下例中实现了一个使用 int 型通道来实现的生成器。通道被命名为<code>yield</code>和<code>resume</code>，这些词经常在协程代码中使用。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>main</span>

<span class=kn>import</span> <span class=p>(</span>
    <span class=s>&#34;fmt&#34;</span>
<span class=p>)</span>

<span class=kd>var</span> <span class=nx>resume</span> <span class=kd>chan</span> <span class=kt>int</span>

<span class=kd>func</span> <span class=nf>integers</span><span class=p>(</span><span class=p>)</span> <span class=kd>chan</span> <span class=kt>int</span> <span class=p>{</span>
    <span class=nx>yield</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>int</span><span class=p>)</span>
    <span class=nx>count</span> <span class=o>:=</span> <span class=mi>0</span>
    <span class=k>go</span> <span class=kd>func</span><span class=p>(</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>for</span> <span class=p>{</span>
            <span class=nx>yield</span> <span class=o>&lt;-</span> <span class=nx>count</span>
            <span class=nx>count</span><span class=o>++</span>
        <span class=p>}</span>
    <span class=p>}</span><span class=p>(</span><span class=p>)</span>
    <span class=k>return</span> <span class=nx>yield</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>generateInteger</span><span class=p>(</span><span class=p>)</span> <span class=kt>int</span> <span class=p>{</span>
    <span class=k>return</span> <span class=o>&lt;-</span><span class=nx>resume</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>main</span><span class=p>(</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>resume</span> <span class=p>=</span> <span class=nf>integers</span><span class=p>(</span><span class=p>)</span>
    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nf>generateInteger</span><span class=p>(</span><span class=p>)</span><span class=p>)</span>  <span class=c1>//=&gt; 0
</span><span class=c1></span>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nf>generateInteger</span><span class=p>(</span><span class=p>)</span><span class=p>)</span>  <span class=c1>//=&gt; 1
</span><span class=c1></span>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nf>generateInteger</span><span class=p>(</span><span class=p>)</span><span class=p>)</span>  <span class=c1>//=&gt; 2    
</span><span class=c1></span><span class=p>}</span>
</code></pre></td></tr></table></div></div><a class=post-dummy-target id=42-futures-模式></a><h3>4.2 Futures 模式</h3><p>所谓Futures就是指：有时候在你使用某一个值之前需要先对其进行计算。这种情况下，你就可以在另一个处理器上进行该值的计算，到使用时，该值就已经计算完毕了。</p><p>Futures模式通过闭包和通道可以很容易实现，类似于生成器，不同地方在于Futures需要返回一个值。</p><p>一个例子： 假设我们有一个矩阵类型，我们需要计算两个矩阵A和B乘积的逆，首先我们通过函数<code>Inverse(M)</code>分别对其进行求逆运算，再将结果相乘。如下函数<code>InverseProduct()</code>实现了如上过程：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=nf>InverseProduct</span><span class=p>(</span><span class=nx>a</span> <span class=nx>Matrix</span><span class=p>,</span> <span class=nx>b</span> <span class=nx>Matrix</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>a_inv</span> <span class=o>:=</span> <span class=nf>Inverse</span><span class=p>(</span><span class=nx>a</span><span class=p>)</span>
    <span class=nx>b_inv</span> <span class=o>:=</span> <span class=nf>Inverse</span><span class=p>(</span><span class=nx>b</span><span class=p>)</span>
    <span class=k>return</span> <span class=nf>Product</span><span class=p>(</span><span class=nx>a_inv</span><span class=p>,</span> <span class=nx>b_inv</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>在这里例子中，a和b的求逆句子的过程可以同时进行，因此换用并行计算方式如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=nf>InverseProduct</span><span class=p>(</span><span class=nx>a</span> <span class=nx>Matrix</span><span class=p>,</span> <span class=nx>b</span> <span class=nx>Matrix</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>a_inv_future</span> <span class=o>:=</span> <span class=nf>InverseFuture</span><span class=p>(</span><span class=nx>a</span><span class=p>)</span>   <span class=c1>// start as a goroutine
</span><span class=c1></span>    <span class=nx>b_inv_future</span> <span class=o>:=</span> <span class=nf>InverseFuture</span><span class=p>(</span><span class=nx>b</span><span class=p>)</span>   <span class=c1>// start as a goroutine
</span><span class=c1></span>    <span class=nx>a_inv</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>a_inv_future</span>
    <span class=nx>b_inv</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>b_inv_future</span>
    <span class=k>return</span> <span class=nf>Product</span><span class=p>(</span><span class=nx>a_inv</span><span class=p>,</span> <span class=nx>b_inv</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><code>InverseFuture</code>函数以<code>goroutine</code>的形式起了一个闭包，该闭包会将矩阵求逆结果放入到future通道中：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=nf>InverseFuture</span><span class=p>(</span><span class=nx>a</span> <span class=nx>Matrix</span><span class=p>)</span> <span class=kd>chan</span> <span class=nx>Matrix</span> <span class=p>{</span>
    <span class=nx>future</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>Matrix</span><span class=p>)</span>
    <span class=k>go</span> <span class=kd>func</span><span class=p>(</span><span class=p>)</span> <span class=p>{</span>
        <span class=nx>future</span> <span class=o>&lt;-</span> <span class=nf>Inverse</span><span class=p>(</span><span class=nx>a</span><span class=p>)</span>
    <span class=p>}</span><span class=p>(</span><span class=p>)</span>
    <span class=k>return</span> <span class=nx>future</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>对计算密集型的场景，使用Futures模式是很有意义的</p><a class=post-dummy-target id=43-cs模式></a><h3>4.3 C/S模式</h3><p>客户端/服务器(C/S)模式是goroutines和channels最常见的应用。</p><p>客户端(Client)可以是运行在任意设备上的任意程序，它会按需发送请求(request)至服务器。服务器(Server)接收到这个请求后开始相应的工作，然后再将响应(response)返回给客户端。典型情况下一般是多个客户端（即多个请求）对应一个（或少量）服务器。例如我们日常使用的浏览器客户端，其功能就是向服务器请求网页。而Web服务器则会向浏览器响应网页数据。</p><p>使用Go的服务器通常会在协程中执行向客户端的响应，故而会对每一个客户端请求启动一个协程。一个常用的操作方法是客户端请求自身中包含一个通道，而服务器则向这个通道发送响应。</p><p>下面是请求<code>Request</code>的结构，响应暗含在请求的结构里面</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=kd>type</span> <span class=nx>Request</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>a</span><span class=p>,</span> <span class=nx>b</span>      <span class=kt>int</span>    
    <span class=nx>replyc</span>    <span class=kd>chan</span> <span class=kt>int</span> <span class=c1>// reply channel inside the Request
</span><span class=c1></span><span class=p>}</span>
</code></pre></td></tr></table></div></div><p>服务器无限循环从<code>chan *Request</code>接收请求，为了避免某个请求长时间操作造成堵塞，为每个请求启动一个协程，然后启动<code>run()</code>函数处理该请求，处理后的值送到<code>chan *Reply</code>通道。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=nf>server</span><span class=p>(</span><span class=nx>op</span> <span class=nx>binOp</span><span class=p>,</span> <span class=nx>service</span> <span class=kd>chan</span> <span class=o>*</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>for</span> <span class=p>{</span>
        <span class=nx>req</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>service</span><span class=p>;</span> <span class=c1>// requests arrive here  
</span><span class=c1></span>        <span class=c1>// start goroutine for request:        
</span><span class=c1></span>        <span class=k>go</span> <span class=nf>run</span><span class=p>(</span><span class=nx>op</span><span class=p>,</span> <span class=nx>req</span><span class=p>)</span><span class=p>;</span>  <span class=c1>// don’t wait for op to complete    
</span><span class=c1></span>    <span class=p>}</span>
<span class=p>}</span>
<span class=kd>type</span> <span class=nx>binOp</span> <span class=kd>func</span><span class=p>(</span><span class=nx>a</span><span class=p>,</span> <span class=nx>b</span> <span class=kt>int</span><span class=p>)</span> <span class=kt>int</span>

<span class=kd>func</span> <span class=nf>run</span><span class=p>(</span><span class=nx>op</span> <span class=nx>binOp</span><span class=p>,</span> <span class=nx>req</span> <span class=o>*</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>req</span><span class=p>.</span><span class=nx>replyc</span> <span class=o>&lt;-</span> <span class=nf>op</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>a</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>b</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>但以上过程仅仅是对客户端的请求是并发处理的，实际上，server本身也是以协程方式启动的</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=nf>startServer</span><span class=p>(</span><span class=nx>op</span> <span class=nx>binOp</span><span class=p>)</span> <span class=kd>chan</span> <span class=o>*</span><span class=nx>Request</span> <span class=p>{</span>
    <span class=nx>reqChan</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=o>*</span><span class=nx>Request</span><span class=p>)</span><span class=p>;</span>
    <span class=k>go</span> <span class=nf>server</span><span class=p>(</span><span class=nx>op</span><span class=p>,</span> <span class=nx>reqChan</span><span class=p>)</span><span class=p>;</span>
    <span class=k>return</span> <span class=nx>reqChan</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>startServer会在<code>main</code>函数中被调用，下面是<code>main</code>函数调用示例，一共发送了100个请求到服务器进行处理， 只有它们全部被送达后我们才会按相反的顺序检查响应：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=nf>main</span><span class=p>(</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>adder</span> <span class=o>:=</span> <span class=nf>startServer</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>a</span><span class=p>,</span> <span class=nx>b</span> <span class=kt>int</span><span class=p>)</span> <span class=kt>int</span> <span class=p>{</span> <span class=k>return</span> <span class=nx>a</span> <span class=o>+</span> <span class=nx>b</span> <span class=p>}</span><span class=p>)</span>
    <span class=kd>const</span> <span class=nx>N</span> <span class=p>=</span> <span class=mi>100</span>
    <span class=kd>var</span> <span class=nx>reqs</span> <span class=p>[</span><span class=nx>N</span><span class=p>]</span><span class=nx>Request</span>
    <span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>N</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
        <span class=nx>req</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>reqs</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span>
        <span class=nx>req</span><span class=p>.</span><span class=nx>a</span> <span class=p>=</span> <span class=nx>i</span>
        <span class=nx>req</span><span class=p>.</span><span class=nx>b</span> <span class=p>=</span> <span class=nx>i</span> <span class=o>+</span> <span class=nx>N</span>
        <span class=nx>req</span><span class=p>.</span><span class=nx>replyc</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>int</span><span class=p>)</span>
        <span class=nx>adder</span> <span class=o>&lt;-</span> <span class=nx>req</span>  <span class=c1>// adder is a channel of requests
</span><span class=c1></span>    <span class=p>}</span>
    <span class=c1>// checks:
</span><span class=c1></span>    <span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=nx>N</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>--</span> <span class=p>{</span>
        <span class=c1>// doesn’t matter what order
</span><span class=c1></span>        <span class=k>if</span> <span class=o>&lt;-</span><span class=nx>reqs</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span><span class=p>.</span><span class=nx>replyc</span> <span class=o>!=</span> <span class=nx>N</span><span class=o>+</span><span class=mi>2</span><span class=o>*</span><span class=nx>i</span> <span class=p>{</span>
            <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=err>“</span><span class=nx>fail</span> <span class=nx>at</span><span class=err>”</span><span class=p>,</span> <span class=nx>i</span><span class=p>)</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=err>“</span><span class=nx>Request</span> <span class=err>“</span><span class=p>,</span> <span class=nx>i</span><span class=p>,</span> <span class=err>“</span><span class=nx>is</span> <span class=nx>ok</span><span class=p>!</span><span class=err>”</span><span class=p>)</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=err>“</span><span class=nx>done</span><span class=err>”</span><span class=p>)</span>
<span class=p>}</span>
<span class=c1>//Output:
</span><span class=c1></span><span class=nx>Request</span> <span class=mi>99</span> <span class=nx>is</span> <span class=nx>ok</span><span class=p>!</span>
<span class=nx>Request</span> <span class=mi>98</span> <span class=nx>is</span> <span class=nx>ok</span><span class=p>!</span>
<span class=o>...</span>
<span class=nx>Request</span> <span class=mi>1</span> <span class=nx>is</span> <span class=nx>ok</span><span class=p>!</span>
<span class=nx>Request</span> <span class=mi>0</span> <span class=nx>is</span> <span class=nx>ok</span><span class=p>!</span>
<span class=nx>done</span>
</code></pre></td></tr></table></div></div><p>完整的程序如下，因为<code>server</code>在<code>main</code>函数返回后是被强制结束的，下面还针对这一点做出改进，方法是提供一个退出通道给server</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>main</span>

<span class=kn>import</span> <span class=s>&#34;fmt&#34;</span>

<span class=kd>type</span> <span class=nx>Request</span> <span class=kd>struct</span> <span class=p>{</span>
	<span class=nx>a</span><span class=p>,</span> <span class=nx>b</span>   <span class=kt>int</span>
	<span class=nx>replyc</span> <span class=kd>chan</span> <span class=kt>int</span> <span class=c1>// reply channel inside the Request
</span><span class=c1></span><span class=p>}</span>

<span class=kd>type</span> <span class=nx>binOp</span> <span class=kd>func</span><span class=p>(</span><span class=nx>a</span><span class=p>,</span> <span class=nx>b</span> <span class=kt>int</span><span class=p>)</span> <span class=kt>int</span>

<span class=kd>func</span> <span class=nf>run</span><span class=p>(</span><span class=nx>op</span> <span class=nx>binOp</span><span class=p>,</span> <span class=nx>req</span> <span class=o>*</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>req</span><span class=p>.</span><span class=nx>replyc</span> <span class=o>&lt;-</span> <span class=nf>op</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>a</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>b</span><span class=p>)</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>server</span><span class=p>(</span><span class=nx>op</span> <span class=nx>binOp</span><span class=p>,</span> <span class=nx>service</span> <span class=kd>chan</span> <span class=o>*</span><span class=nx>Request</span><span class=p>,</span> <span class=nx>quit</span> <span class=kd>chan</span> <span class=kt>bool</span><span class=p>)</span> <span class=p>{</span>
	<span class=k>for</span> <span class=p>{</span>
		<span class=k>select</span> <span class=p>{</span>
		<span class=k>case</span> <span class=nx>req</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>service</span><span class=p>:</span>
			<span class=k>go</span> <span class=nf>run</span><span class=p>(</span><span class=nx>op</span><span class=p>,</span> <span class=nx>req</span><span class=p>)</span>
		<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>quit</span><span class=p>:</span>
			<span class=k>return</span>
		<span class=p>}</span>
	<span class=p>}</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>startServer</span><span class=p>(</span><span class=nx>op</span> <span class=nx>binOp</span><span class=p>)</span> <span class=p>(</span><span class=nx>service</span> <span class=kd>chan</span> <span class=o>*</span><span class=nx>Request</span><span class=p>,</span> <span class=nx>quit</span> <span class=kd>chan</span> <span class=kt>bool</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>service</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=o>*</span><span class=nx>Request</span><span class=p>)</span>
	<span class=nx>quit</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>bool</span><span class=p>)</span>
	<span class=k>go</span> <span class=nf>server</span><span class=p>(</span><span class=nx>op</span><span class=p>,</span> <span class=nx>service</span><span class=p>,</span> <span class=nx>quit</span><span class=p>)</span>
	<span class=k>return</span> <span class=nx>service</span><span class=p>,</span> <span class=nx>quit</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>main</span><span class=p>(</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>adder</span><span class=p>,</span> <span class=nx>quit</span> <span class=o>:=</span> <span class=nf>startServer</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>a</span><span class=p>,</span> <span class=nx>b</span> <span class=kt>int</span><span class=p>)</span> <span class=kt>int</span> <span class=p>{</span> <span class=k>return</span> <span class=nx>a</span> <span class=o>+</span> <span class=nx>b</span> <span class=p>}</span><span class=p>)</span>
	<span class=kd>const</span> <span class=nx>N</span> <span class=p>=</span> <span class=mi>100</span>
	<span class=kd>var</span> <span class=nx>reqs</span> <span class=p>[</span><span class=nx>N</span><span class=p>]</span><span class=nx>Request</span>
	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>N</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
		<span class=nx>req</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>reqs</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span>
		<span class=nx>req</span><span class=p>.</span><span class=nx>a</span> <span class=p>=</span> <span class=nx>i</span>
		<span class=nx>req</span><span class=p>.</span><span class=nx>b</span> <span class=p>=</span> <span class=nx>i</span> <span class=o>+</span> <span class=nx>N</span>
		<span class=nx>req</span><span class=p>.</span><span class=nx>replyc</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>int</span><span class=p>)</span>
		<span class=nx>adder</span> <span class=o>&lt;-</span> <span class=nx>req</span>
	<span class=p>}</span>
	<span class=c1>// checks:
</span><span class=c1></span>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=nx>N</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>--</span> <span class=p>{</span> <span class=c1>// doesn&#39;t matter what order
</span><span class=c1></span>		<span class=k>if</span> <span class=o>&lt;-</span><span class=nx>reqs</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span><span class=p>.</span><span class=nx>replyc</span> <span class=o>!=</span> <span class=nx>N</span><span class=o>+</span><span class=mi>2</span><span class=o>*</span><span class=nx>i</span> <span class=p>{</span>
			<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;fail at&#34;</span><span class=p>,</span> <span class=nx>i</span><span class=p>)</span>
		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
			<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Request &#34;</span><span class=p>,</span> <span class=nx>i</span><span class=p>,</span> <span class=s>&#34; is ok!&#34;</span><span class=p>)</span>
		<span class=p>}</span>
	<span class=p>}</span>
	<span class=nx>quit</span> <span class=o>&lt;-</span> <span class=kc>true</span>
	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;done&#34;</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div></div><div class=post-copyright id=post-footer><p class=copyright-item><span>Author:&nbsp;</span>
<span>shuzang</span></p><p class=copyright-item><span>Updated on:&nbsp;</span>
<span>2019-12-16</span></p><p class=copyright-item><span>Share on:&nbsp;</span>
<span><a href="//twitter.com/share?url=https%3a%2f%2fxushun1221.github.io%2f2019%2fgolang-syntax-10-goroutine-and-channel%2f&text=Golang%e8%af%ad%e6%b3%95%e5%9f%ba%e7%a1%8010-%e5%8d%8f%e7%a8%8b%e4%b8%8e%e9%80%9a%e9%81%93&via=" target=_blank title="Share on Twitter"><i class="fab fa-twitter fa-fw"></i></a><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fxushun1221.github.io%2f2019%2fgolang-syntax-10-goroutine-and-channel%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook-square fa-fw"></i></a><a href="//reddit.com/submit?url=https%3a%2f%2fxushun1221.github.io%2f2019%2fgolang-syntax-10-goroutine-and-channel%2f&title=Golang%e8%af%ad%e6%b3%95%e5%9f%ba%e7%a1%8010-%e5%8d%8f%e7%a8%8b%e4%b8%8e%e9%80%9a%e9%81%93" target=_blank title="Share on Reddit"><i class="fab fa-reddit fa-fw"></i></a></span></p><p class=copyright-item></p><p class=copyright-item></p></div><br><div class=post-info-more><section><span class=tag><a href=https://xushun1221.github.io/tags/go%E8%AF%AD%E6%B3%95/><i class="fas fa-tag fa-fw"></i>&nbsp;Go语法</a>&nbsp;</span></section><section><span><a href=javascript:window.history.back();>Back</a></span>&nbsp;|&nbsp;<span><a href=https://xushun1221.github.io>Home</a></span></section></div><div class=post-nav><a href=https://xushun1221.github.io/2019/life-skills-9-maintenance-storage-and-disposal-of-used-clothes/ class=prev rel=prev title=穿搭整理3-保养、收纳及旧衣处理><i class="fas fa-angle-left fa-fw"></i>穿搭整理3-保养、收纳及旧衣处理</a>
<a href=https://xushun1221.github.io/2019/linux%E7%B3%BB%E7%BB%9F%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5/ class=next rel=next title=linux系统时间同步>linux系统时间同步<i class="fas fa-angle-right fa-fw"></i></a></div><div class=post-comment></div></article></div></main><footer class=footer><div class=copyright><div class=copyright-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2018 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://shuzang.github.io/about/ target=_blank>shuzang</a> | </span>Powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreffer">Hugo</a> & <a href=https://github.com/dillonzq/LoveIt target=_blank rel="external nofollow noopener noreffer">LoveIt</a></div></div></footer></div><a href=# class=dynamic-to-top id=dynamic-to-top data-scroll><span>&nbsp;</span></a>
<script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-209130979-1','auto');ga('set','anonymizeIp',true);ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=/js/lib/jquery/jquery.slim.min.js></script><script src=/js/lib/lazysizes/lazysizes.min.js></script><script src=/js/lib/smooth-scroll/smooth-scroll.polyfills.min.js></script><script>window.scroll=new SmoothScroll('[data-scroll]',{speed:300,speedAsDuration:true});</script><link rel=stylesheet href=/css/lib/katex/katex.min.css><script src=/js/lib/katex/katex.min.js></script><script defer src=/js/lib/katex/auto-render.min.js></script><link rel=stylesheet href=/css/lib/katex/copy-tex.min.css><script defer src=/js/lib/katex/copy-tex.min.js></script><script defer src=/js/lib/katex/mhchem.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:true},{left:"\\(",right:"\\)",display:false},{left:"\\[",right:"\\]",display:true},{left:"$",right:"$",display:false},]});});</script><script src=/js/blog.min.js></script></body></html>